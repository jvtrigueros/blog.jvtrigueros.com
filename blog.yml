---
- hosts: localhost
  become: yes

  vars:
    ghost:
      install_dir: /var/www
      version: "0.11.7"

  pre_tasks:
    - name: apt-get update
      apt: update_cache=yes

    - name: ensure installation requirements are installed
      apt:
        name: "{{ item }}"
        state: present
      with_items:
        - curl
        - unzip
        - nginx

    - name: verify that Node.js is installed
      command: node --version
      ignore_errors: yes
      register: node

    - name: download Node.js setup script
      get_url:
        url: https://deb.nodesource.com/setup_4.x
        dest: /var/cache/node-setup.sh
      when: node|failed

    - name: install Node.js apt repository
      command: bash /var/cache/node-setup.sh
      when: node|failed

    - name: ensure Node.js is installed
      apt:
        name: nodejs
        state: present

  tasks:
    - name: download ghost
      get_url:
        url: https://github.com/TryGhost/Ghost/releases/download/{{ ghost.version }}/Ghost-{{ ghost.version }}.zip
        dest: /var/cache/ghost.zip

    - name: extract ghost
      shell: mkdir -p /var/www && unzip /var/cache/ghost.zip -d /var/www/ghost
